<!DOCTYPE html>
	<html>

		<head>

<script>
var host = "mulham.github.io";
if ((host == window.location.host) && (window.location.protocol != "https:"))
    window.location.protocol = "https";
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80564042-1', 'auto');
  ga('send', 'pageview');

</script>
<link rel="icon" href="/favicon.png">
<meta name="google" content="notranslate" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="/css/main.css">

<meta name="description" content="شرح شامل ومُيسَّر لطريقة إنشاء منتدى متكامل باستخدام php و MySQL من البداية" />




			<title>إنشاء منتدى PHP من الصفر</title>
			<!-- link to main stylesheet -->
			
		</head>
		<body>
			<nav>
	    		<ul>
	                	<li><a href="/">الرئيسية</a></li>
						<li><a href="/blog">المدونة</a></li>
						<li><a href="/tutorials">دروس</a></li>
						<li><a href="/about/request">طلب ترجمة</a></li>
						<li><a href="/urls">روابط مفيدة</a></li>
						<li><a href="/about">عن الموقع</a></li>
	    		</ul>
			</nav>
			<div class="container">
			
			<h1>إنشاء منتدى PHP من الصفر</h1>
<p class="meta">20 Jun 2016




</p>





<div class="post">
  <p>هذا الدرس من تأليف Evert padje وترجمتي (ملهم)، يركّز الدرس على إنشاء منتدى باستخدام php و Mysql من أجل قاعدة بيانات المنتدى .. وهو لغرض تعليمي، يمكن معاينة المنتدى الناتج على <a href="http://inkshouse.heroicmice.com/forum/index.php">هذا الرابط</a></p>

<p>سنقوم في هذا الشرح ببناء منتدى PHP/MySQL من الصفر. هذا الشرح أيضاً ممتاز للاعتياد على أساسيات لغة البرمجة php وقواعد بيانات MySQL . لنبدأ سويةً !</p>

<ul id="markdown-toc">
  <li><a href="#أولاً--إنشاء-جداول-قاعدة-البيانات-" id="markdown-toc-أولاً--إنشاء-جداول-قاعدة-البيانات-">أولاً : إنشاء جداول قاعدة البيانات :</a>    <ul>
      <li><a href="#جدول-المستخدمين" id="markdown-toc-جدول-المستخدمين">جدول المستخدمين</a>        <ul>
          <li><a href="#user_id" id="markdown-toc-user_id">user_id</a></li>
          <li><a href="#user_name" id="markdown-toc-user_name">user_name</a></li>
          <li><a href="#user_pass" id="markdown-toc-user_pass">user_pass</a></li>
          <li><a href="#user_email" id="markdown-toc-user_email">user_email</a></li>
          <li><a href="#user_date" id="markdown-toc-user_date">user_date</a></li>
          <li><a href="#user_level" id="markdown-toc-user_level">user_level</a></li>
        </ul>
      </li>
      <li><a href="#جدول-التصنيفات" id="markdown-toc-جدول-التصنيفات">جدول التصنيفات</a></li>
      <li><a href="#جدول-المواضيع" id="markdown-toc-جدول-المواضيع">جدول المواضيع</a></li>
      <li><a href="#جدول-التعليقات" id="markdown-toc-جدول-التعليقات">جدول التعليقات</a></li>
    </ul>
  </li>
  <li><a href="#ثانياً-مقدمة-لنظام-الترويسةالتذييل" id="markdown-toc-ثانياً-مقدمة-لنظام-الترويسةالتذييل">ثانياً: مقدمة لنظام الترويسة/التذييل</a>    <ul>
      <li><a href="#ملف-الترويسة-headerphp" id="markdown-toc-ملف-الترويسة-headerphp">ملف الترويسة header.php</a></li>
    </ul>
  </li>
  <li><a href="#ثالثاً-البدء-بالتنفيذ-الفعلي" id="markdown-toc-ثالثاً-البدء-بالتنفيذ-الفعلي">ثالثاً: البدء بالتنفيذ الفعلي</a></li>
  <li><a href="#رابعاً-عرض-المنتدى" id="markdown-toc-رابعاً-عرض-المنتدى">رابعاً: عرض المنتدى</a></li>
  <li><a href="#خامساً-اشتراك-مستخدم" id="markdown-toc-خامساً-اشتراك-مستخدم">خامساً: اشتراك مستخدم</a>    <ul>
      <li><a href="#التأكد-من-البيانات" id="markdown-toc-التأكد-من-البيانات">التأكد من البيانات</a></li>
    </ul>
  </li>
  <li><a href="#سادساً-إضافة-التفعيل-ومستوى-المستخدم" id="markdown-toc-سادساً-إضافة-التفعيل-ومستوى-المستخدم">سادساً: إضافة التفعيل ومستوى المستخدم</a></li>
  <li><a href="#سابعاً-إنشاء-تصنيف" id="markdown-toc-سابعاً-إنشاء-تصنيف">سابعاً: إنشاء تصنيف</a></li>
  <li><a href="#ثامناً-إضافة-تصنيفات-للصفحة-الرئيسية-indexphp" id="markdown-toc-ثامناً-إضافة-تصنيفات-للصفحة-الرئيسية-indexphp">ثامناً: إضافة تصنيفات للصفحة الرئيسية index.php</a></li>
  <li><a href="#تاسعاً-إنشاء-موضوع" id="markdown-toc-تاسعاً-إنشاء-موضوع">تاسعاً: إنشاء موضوع</a>    <ul>
      <li><a href="#عرض-النموذج" id="markdown-toc-عرض-النموذج">عرض النموذج</a></li>
      <li><a href="#معالجة-النموذج" id="markdown-toc-معالجة-النموذج">معالجة النموذج</a></li>
    </ul>
  </li>
  <li><a href="#عاشراً--عرض-التصنيفات" id="markdown-toc-عاشراً--عرض-التصنيفات">عاشراً : عرض التصنيفات</a></li>
  <li><a href="#الخطوة-11--عرض-المواضيع" id="markdown-toc-الخطوة-11--عرض-المواضيع">الخطوة 11 : عرض المواضيع</a></li>
  <li><a href="#الخطوة-12--إضافة-تعليق" id="markdown-toc-الخطوة-12--إضافة-تعليق">الخطوة 12 : إضافة تعليق</a></li>
  <li><a href="#النهاية" id="markdown-toc-النهاية">النهاية</a></li>
</ul>

<h1 id="أولاً--إنشاء-جداول-قاعدة-البيانات-">أولاً : إنشاء جداول قاعدة البيانات :</h1>

<p>دائماً ، وقبل البدء بإنشاء أي تطبيق وب،  من الجيد القيام بإنشاء قاعدة بيانات جيدة لإدخال البيانات بشكل جيد . لنصف تطبيقنا الذي نريد إنشاؤه بجملة واحدة : سنقوم بإنشاء منتدى يحوي على مستخدمين يقوموا بإنشاء مواضيع بـ تصنيفات مختلفة ، المستخدمين الآخرين يمكنهم إضافة تعليق .</p>

<p>وكما ترى ، لقد قمت بالتركيز على كلمات معينة لتمثل أسماء الجداول في قاعدة البيانات التي نريدها .</p>

<ul>
  <li>
    <p>المستخدمون users</p>
  </li>
  <li>
    <p>التصنيفات categories</p>
  </li>
  <li>
    <p>المواضيع topics</p>
  </li>
  <li>
    <p>التعليقات replies</p>
  </li>
</ul>

<p>العناصر الثلاثة الأخيرة مرتبطة ببعضها البعض ، لذا سنقوم بعمل ذلك في تصميم الجدول .</p>

<blockquote>
  <p>يمكن إنشاء قاعدة بيانات MySQL باستخدام أوامر Sql ، ولكننا هنا سنستخدم برنامج بواجهة رسومية ليسهل العملية ويجعلها مفهومة أكثر ، وممتعة أكثر . البرنامج هو <a href="http://dev.mysql.com/downloads/workbench/">Workbench</a>  ، يمكنك التعرف عليه أكثر من خلال هذه المشاركة ، ولكن ذلك غير مطلوب لفهم تكملة هذا الشرح .</p>
</blockquote>

<p>ألقِ نظرة على المخطط أدناه</p>

<p><img src="/assets/php.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر" /></p>

<p>يبدو مرتباً أليس كذلك ؟ كل مربع هو عبارة عن جدول في قاعدة البيانات . جميع الأعمدة مدونة داخل كل جدول .. والخطوط بين الجداول تمثل العلاقة بينهم . سوف نشرح ذلك لاحقاً ، لا بأس إن لم تفهم الكثير الآن ..</p>

<p>سوف نناقش كل جدول بشرح أوامر Sql . والتي تم إنشاءها تلقائياً مع إنشاء المخطط في الأعلى . لصنع كودك الخاص يمكنك إنشاء مخطط مشابه وستحصل على أوامر الـ Sql التي قامت بإنشاء المخطط أيضاً . بعض محررات قواعد البيانات مثل MySQL Workbench الذي قمنا بإستخدامه لإنتاج ذلك المخطط ينتج ملفات بلاحقة Sql أيضاً . ولكننا ننصح تعلم أوامر Sql حيث ستجد الأمر ممتعاً . لمقدمة حول Sql يمكنك قراءة المشاركة <a href="sql/intro">هنا</a> .</p>

<h2 id="جدول-المستخدمين">جدول المستخدمين</h2>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span>
<span class="n">user_id</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">user_name</span>
<span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">user_pass</span>
<span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">user_email</span> <span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">user_date</span>
<span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">user_level</span> <span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">user_name_unique</span> <span class="p">(</span><span class="n">user_name</span><span class="p">),</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="p">)</span> <span class="k">TYPE</span><span class="o">=</span><span class="n">INNODB</span><span class="p">;</span></code></pre></figure>

<p>تستخدم عبار <code class="highlighter-rouge">CREATE TABLE</code> لإنشاء جدول جديد. يتبع هذه العبارة اسم الجدول المراد إنشاؤه، ويتم وضع جميع أعمدة الجدول بين قوسين. بالنسبة لأسماء الحقول فهي تشرح نفسها بنفسها، لذا سنناقش الآن أنواع البيانات فقط.</p>

<h3 id="user_id">user_id</h3>

<p>مفتاح أولي يستخدم لتعريف كل عمود في الجدول بشكل فريد (غير قابل للتكرار).
نوع هذا الحقل هو <code class="highlighter-rouge">INT</code>، وهذا يعني أن الحقل يجب أن يحوي على عدد صحيح (غير عشري). ولا يمكن لهذا الحقل أن يكون فارغاً بما أننا استخدمنا عبارة (NOT NULL). يمكن أن ترى في أسفل الجدول أن حقل user_id تم تحديده على أنه مفتاح أولي (primary key). يستخدم المفتاح الأولي كما ذكرنا لتعريف كل عمود في الجدول بشكل فريد،أي لا يمكن لأي عمودين في الجدول أن يكون لهم نفس القيمة لهذا الحقل. الكلام غير واضح؟ بالمثال يزول الإشكال :</p>

<p>لدينا مستخدم على سبيل المثال يدعى أحمد، إذا قام مستخدم آخر بالتسجيل وبنفس الاسم، فسيكون هناك مشكلة. ﻷنه لا يمكن التفريق بين أحمد هذا وأحمد ذاك. لا يمكنك التفريق ولا يمكن حتى لقاعدة البيانات حينها التفريق بينهم. يتم حل هذه المشكلة باستخدام المتاح الأولي (primary key) ، حيث سيعطى للاسمين رقم مختلف.</p>

<p>جميع الجداول الأخرى تحوي على مفاتيح أولية وتعمل بنفس الطريقة.</p>

<h3 id="user_name">user_name</h3>

<p>هذا حقل نصي (وليس رقمي كالحقل السابق). يدعي الحقل بلغة SQL حقل VARCHAR وهو أحد أنواع الحقول النصية. الرقم بين الأقواس هو أقصى طول لعدد الأحرف التي يمكن أن يتم إدخالها في الحقل. في حالتنا هذه يمكن للمستخدم اختيار اسم يبلغ طوله كحد أقصى 30 حرف. ولا يمكن لهذا الحقل أن يكون فارغاً (NOT NULL)، سترى أسفل الجدول أن هذا الحقل تم تحديده على أنه فريد (UNIQUE)، وهذا يعني أنه لا يمكن لشخصين التسجيل بنفس الاسم.</p>

<p>الجزء الذي يحوي على عبارة <code class="highlighter-rouge">UNIQUE INDEX</code> يُخبر قاعدة البيانات أننا نريد إضافة مفتاح فريد (UNIQUE KEY)، بعدها قمنا بتحديد اسم المفتاح الفريد وهو هنا <code class="highlighter-rouge">user_name_unique</code> ، وبين الأقواس اسم الحقل الذي سينطبق المفتاح الفريد عليه (ليصبح غير قابل لتكرار قيمته مرتين في الجدول).</p>

<h3 id="user_pass">user_pass</h3>

<p>هذا الحقل نفس الحقل السابق، باستثناء الطول الأقصى له ، فبما أن كلمة سر المستخدم ومهما كان طولها سيتم تشفيرها لنوع تشفير sha1 ، فكلمة السر ستكون دائماً مع نوع التشفير هذا بطول 40 حرف.</p>

<p>توضيح: حين تدخل أي كملة سر ولنفترض 123 أو لتكن mulham أو أي شيئ آخر ومهما يكن طول كلمة السر التي ستدخلها، يتم تطبيق تشفير لكلمة السر هذه قبل حفظها في قاعدة البيانات وذلك للأمان، بحيث اذا استطاع أحد ما بالوصول لقاعدة البيانات بالخطأ، فلن يتمكن من معرفة كلمات سر المستخدمين، وهناك أنواع كثير للتشفير منها هذا النوع <code class="highlighter-rouge">sha1</code> والذي يحول أي كلمة سر ل 40 حرف (أحرف وأرقام)، وعند نموذج دخول المستخدم (بعد اشتراكه)، نطبق نفس نوع التشفير على كلمة السر المدخلة لنقارن قيمة تشفير الكلمة المدخلة مع قيمة التشفير المحفوظة في قاعدة البيانات، فإذا طابقها، ولج المستخدم للموقع بشكل صحيح.</p>

<h3 id="user_email">user_email</h3>

<p>هذا الحقل هو تماماً نفس الحقل السابق (بالنسبة لقاعدة البيانات، أما لاحقاً عند عمل نموذج دخول بلغة HTML فيختلف الموضوع قليلاً )</p>

<h3 id="user_date">user_date</h3>

<p>في هذا الحقل يتم تخزين التاريخ الذي قام به المستخدم بالتسجيل. نوع هذا الحقل هو <code class="highlighter-rouge">DATETIME</code> ولا يمكن أن يكون فارغ. (يتم تعبئة الحقل تلقائياً بحسب توقيت السيرفر).</p>

<h3 id="user_level">user_level</h3>

<p>يحوي هذا الحقل مستوى المستخدم، على سبيل المثال: 0 للمستخدم العادي و 1 للمدير. ستتعرف على المزيد لاحقاً.</p>

<h2 id="جدول-التصنيفات">جدول التصنيفات</h2>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">categories</span> <span class="p">(</span>
<span class="n">cat_id</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">cat_name</span>
<span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">cat_description</span>
<span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">cat_name_unique</span> <span class="p">(</span><span class="n">cat_name</span><span class="p">),</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">)</span>
<span class="p">)</span> <span class="k">TYPE</span><span class="o">=</span><span class="n">INNODB</span></code></pre></figure>

<p>أنواع البيانات هنا تعمل بشكل أساسي بنفس الطريقة التي تعمل بها أنواع البيانات في جدول المستخدمين. يحوي هذا الجدول أيضاً مفتاح أولي ، واسم التصنيف يجب أن يكون فريد .</p>

<h2 id="جدول-المواضيع">جدول المواضيع</h2>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> 

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">topics</span> <span class="p">(</span>
<span class="n">topic_id</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">topic_subject</span>
<span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">topic_date</span>
<span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">topic_cat</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">topic_by</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">topic_id</span><span class="p">)</span>
<span class="p">)</span> <span class="k">TYPE</span><span class="o">=</span><span class="n">INNODB</span><span class="p">;</span></code></pre></figure>

<p>هذا الجدول تقريباً نفس الجداول السابقة، باستثناء حقل <code class="highlighter-rouge">topic_by</code> والذي يشير للمستخدم المنشئ للموضوع. وحقل <code class="highlighter-rouge">topic_cat</code> الذي يشير للتصنيف الذي يتبع الموضوع له. لا يمكن تحديد العلاقات بين هذه الحقول بذكر أسماء الحقول فقط. فيجب أن نُعلم قاعدة البيانات أن هذا الحقل (<code class="highlighter-rouge">topic_by</code>) يجب أن يحتوي على الرقم التسلسلي <code class="highlighter-rouge">user_id</code> لمستخدم موجود في جدول المستخدمين، والحقل الآخر (<code class="highlighter-rouge">topic_cat</code>) يجب أن يحتوي على الرقم التسلسلي cat_id لتصنيف موجود في جدول التصنيفات. سنضيف هذه العلاقات بين الحقول والجداول بعد مناقشة جدول التعليقات.</p>

<h2 id="جدول-التعليقات">جدول التعليقات</h2>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> 

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">posts</span> <span class="p">(</span>
<span class="n">post_id</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">post_content</span>
<span class="n">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">post_date</span>
<span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">post_topic</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">post_by</span>
<span class="n">INT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
<span class="p">)</span> <span class="k">TYPE</span><span class="o">=</span><span class="n">INNODB</span><span class="p">;</span></code></pre></figure>

<p>هذا الجدول هو نفس بقية الجداول، ويوجد هنا أيضاً حقل يشير لرقم مستخدم user_id في جدول المستخدمين : حقل <code class="highlighter-rouge">post_by</code> ، حقل <code class="highlighter-rouge">post_topic</code> يشير للموضوع الذي يتبع التعليق له .</p>

<p>المفتاح الخارجي <code class="highlighter-rouge">foreign key</code> هو قيد مرجعي بين جدولين. يُعرِّف المفتاح الخارجي عمود أو مجموعة أعمدة في جدول (مرجعي) والذي يشير لعمود أو مجموعة أعمدة في جدول (مرجعي) آخر .</p>

<p>الآن وبعد تنفيذ هذه التعليمات وإنشاء الجداول. أصبح لدينا ترتيب بيانات جيد، ولكن العلاقات بين هذه البيانات مازالت مفقودة. لنبدأ بتعريف أحد هذه العلاقات. سوف نستخدم شيئ يدعي المفتاح الخارجي. بعض الشروط لهذا الاستخدام:</p>

<ul>
  <li>
    <p>العمود في الجدول المرجعي والذي يشير له المفتاح الخارجي يجب أن يكون مفتاح أولي.</p>
  </li>
  <li>
    <p>القيم المشار لها يجب أن تكون موجودة في الجدول المرجعي.</p>
  </li>
</ul>

<p>أعرف أن كل هذه المصطلحات جديدة عليك، ولكنك ستكتشف أنها بسيطة جداً، هي فقط علاقة بين جدول وآخر ، ستتضح لك الأمور في السطور القادمة.</p>

<p>بإضافة مفاتيح خارجية تصبح المعلومات مرتبطة ببعضها، وهذا مهم جداً في ترتيب قاعدة البيانات.</p>

<p>الآن أصبحت تعرف نوعاً ما ما هو المفتاح الخارجي ولماذا نستخدمه. حان الوقت لإضافة مفاتيح خارجية للجداول التي أنشأناها باستخدام عبارة <code class="highlighter-rouge">ALTER</code>، والتي تستخدم لتعديل جدول موجود مسبقاً.</p>

<p>سنقوم في البداية بربط المواضيع بالتصنيفات:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">topics</span> <span class="k">ADD</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">topic_cat</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">categories</span><span class="p">(</span><span class="n">cat_id</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CASCADE</span><span class="p">;</span></code></pre></figure>

<p>الجزء الأخير من التعليمة يوضح ما يجري. فعندما يتم حذف التصنيف من قاعدة البيانات، جميع المواضيع المرتبطة بهذا التصنيف سيتم حذفها أيضاً. إذا تم تغيير قيمة cat_id لتصنيف ما، جميع المواضيع المرتبطة بهذا التصنيف سيتم تحديثها أيضاً. وهذا ما تقوم به عبارة <code class="highlighter-rouge">ON UPDATE CASCADE</code> . بالطبع يمكنك التراجع عن ذلك لحماية بياناتك، وذلك بجعل حذف تنصيف ما غير ممكن ما زال هناك مواضيع مرتبطة بهذا التصنيف، إذا أردت القيام بذلك، فعليك استبدال <code class="highlighter-rouge">ON DELETE</code> <code class="highlighter-rouge">CASCADE</code> إلى <code class="highlighter-rouge">ON DELETE RESTRICT</code> . يوجد أيضاً عبارات <code class="highlighter-rouge">SET NULL</code> أي اجعله فارغاً و <code class="highlighter-rouge">NO ACTION</code> أي لا تقم بأي إجراء.</p>

<p>الآن، كل موضوع أصبح مرتبط بتصنيف ما. لنقم بربط المواضيع بالمستخدمين المنشئين لهم.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> 

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">topics</span> <span class="k">ADD</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">topic_by</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">users</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">RESTRICT</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CASCADE</span><span class="p">;</span></code></pre></figure>

<p>المفتاح الخارجي هنا هو نفسه كسابقه، ولكن هناك فرق واحد: لا يمكن حذف المستخدم ما زال هناك مواضيع مرتبطة به، أو بالأحرى مرتبطة بـ <code class="highlighter-rouge">user_id</code> للمستخدم (رقمه التسلسلي في قاعدة البيانات). لم نضع هنا <code class="highlighter-rouge">ON DELETE CASCADE</code>  ﻷننا لا نريد للمعلومات المرتبطة بحساب ما والتي قد تكون قيمة أن تُحذف عندما يقرر المستخدم حذف حسابه. 
لإبقاء خيار حذف الحساب متاحاً للمستخدمين، يجب أن تقوم بإنشاء ميزة تنقل المواضيع لحساب “مجهول” عند حذف مستخدم لحسابه. وفي الواقع هذا ليش موضوع نقاشنا في هذا الشرح.</p>

<p>ربط التعليقات بالمواضيع:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> 

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">posts</span> <span class="k">ADD</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">post_topic</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">topics</span><span class="p">(</span><span class="n">topic_id</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CASCADE</span><span class="p">;</span></code></pre></figure>

<p>وأخيراً، ربط كل تعليق بالمستخدم المنشئ له:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">posts</span> <span class="k">ADD</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">post_by</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">users</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">RESTRICT</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CASCADE</span><span class="p">;</span></code></pre></figure>

<p>انتهى الجزء الخاص بقاعدة البيانات! لقد كان عملاً متعباً نوعاً ما، ولكن النتيجة تستحق هذا العمل، حيث حصلنا على قاعدة بيانات نموذجبة.</p>

<h1 id="ثانياً-مقدمة-لنظام-الترويسةالتذييل">ثانياً: مقدمة لنظام الترويسة/التذييل</h1>

<p>كل صفحة في منتدانا تتطلب بعض الأشياء الأساسية، مثل بعض الترميزات والتنسيقات. ولذا سنقوم بتضمين ملف الترويسة header.php بأعلى كل صفحة في المنتدى، والتذييل footer.php أسفل كل صفحة. يتضمن ملف الترويسة الترميزات الأساسية وروابط للملفات التي يجب تحميلها لعرض المنتدى بشكل جيد، وكذلك بعض المعلومات المهمة حول المنتدى، مثل العنوان والأيقونة والشعار..</p>

<h2 id="ملف-الترويسة-headerphp">ملف الترويسة header.php</h2>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span> <span class="na">xml:lang=</span><span class="s">"nl"</span> <span class="na">lang=</span><span class="s">"nl"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">"A short description."</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"keywords"</span> <span class="na">content=</span><span class="s">"put, keywords, here"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>PHP-MySQL forum<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"style.css"</span> <span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>My forum<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">href=</span><span class="s">"/forum/index.php"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span> -
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">href=</span><span class="s">"/forum/create_topic.php"</span><span class="nt">&gt;</span>Create a topic<span class="nt">&lt;/a&gt;</span> -
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">href=</span><span class="s">"/forum/create_cat.php"</span><span class="nt">&gt;</span>Create a category<span class="nt">&lt;/a&gt;</span>
         
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"userbar"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"userbar"</span><span class="nt">&gt;</span>Hello Example. Not you? Log out.<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span></code></pre></figure>

<p>سنستخدم وسم <code class="highlighter-rouge">&lt;div id="wrapper"&gt;</code>  لجعل تنسيق كامل الصفحة أسهل. الوسم <code class="highlighter-rouge">&lt;div id="menu"&gt;</code> كما هو واضح يضم قائمة بروابط لصفحات الموقع التي سننشؤها لاحقاً. وسم <code class="highlighter-rouge">&lt;div id="userbar"&gt;</code> سيستخدم كشريط علوي يضم معلومات مثل اسم المستخدم ورابط لتسجيل الخروج. والوسم الأخير سيحوي بشكل واضح المعلومات الفعلية للصفحة التي يكون بها المستخدم.</p>

<p>إذا كنت تقرأ بانتباه، فربما لاحظت أننا فقدنا شيئاً ما. فلم ننهي وسمي <code class="highlighter-rouge"><span class="nt">&lt;html&gt;</span></code> و <code class="highlighter-rouge">&lt;body&gt;</code> كما هو واجب في لغة html. أي لم نكتب في نهاية ملف الترويسة <code class="highlighter-rouge">&lt;/body&gt; &gt;/html&gt;</code>
والسبب هو أننا سنضعهم في ملف التذييل <code class="highlighter-rouge">footer.php</code> :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- content --&gt;</span>
<span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- wrapper --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"footer"</span><span class="nt">&gt;</span>Created for Nettuts+<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure>

<p>عندما نضمّن ملفي الترويسة والتذييل في كل صفحة، فإن محتوى الصفحة الفعلي سيظهر بين الترويسة (بداية الصفحة) والتذييل (نهاية الصفحة). لهذه الطريقة عدة فوائد. أولها وأهمها أن كل شيئ سيكون منسق بشكل صحيح. مثال سريع :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"> 

<span class="cp">&lt;?php</span>
<span class="nv">$error</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$error</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//the beautifully styled content, everything looks good
</span>    <span class="k">echo</span> <span class="s1">'&lt;div id="content"&gt;some text&lt;/div&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//bad looking, unstyled error :-( 
</span><span class="p">}</span> 
<span class="cp">?&gt;</span></code></pre></figure>

<p>كما ترى، إذا لم يحدث أخطاء في الصفحة فستظهر بشكل أنيق. أما اذا كان هناك خطأ، فكل شيئ سيكون مبعثر. ولهذا السبب يجب دائماً التأكد ليس من تنسيق المحتوى فقط، وإنما أيضاً من الأخطاء التي يمكن أن تحدث.</p>

<p>ميزة أخرى لهذه الطريقة (تضمين ملفي الترويسة والتذييل) هو إمكانية عمل تغييرات سريعة. فسترى أنك وبعد إنهاء هذا الشرح إذا أردت التعديل على ملف التذييل مثلاً footer.php، فسترى أن التذييل سينطبق مباشرة على كل صفحة في المنتدى.</p>

<p>أخيراً سوف نقوم بإضافة بعض التنسيقات والتي تزودنا بإظهارات وترميزات أساسية. لا شيئ معقد هنا، ولا داعي لفهم الكود.</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">body</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#4E4E4E</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>         <span class="c">/* make sure IE centers the page too */</span>
<span class="p">}</span>
 
<span class="nf">#wrapper</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">900px</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>             <span class="c">/* center the page */</span>
<span class="p">}</span>
 
<span class="nf">#content</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#000</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nl">font-family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">20px</span> <span class="m">30px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>                <span class="c">/* fill up the entire div */</span>
<span class="p">}</span>
 
<span class="nf">#menu</span> <span class="p">{</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#000</span><span class="p">;</span>
    <span class="nl">border-bottom</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>        <span class="c">/* avoid a double border */</span>
    <span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span>                <span class="c">/* clear:both makes sure the content div doesn't float next to this one but stays under it */</span>
    <span class="nl">width</span><span class="p">:</span><span class="m">100%</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span><span class="m">20px</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">30px</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#FFF</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">85%</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nf">#menu</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#009FC1</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nf">#userbar</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">250px</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nf">#footer</span> <span class="p">{</span>
    <span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c">/* begin table styles */</span>
<span class="nt">table</span> <span class="p">{</span>
    <span class="nl">border-collapse</span><span class="p">:</span> <span class="nb">collapse</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">table</span> <span class="nt">a</span> <span class="p">{</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#000</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">table</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">color</span><span class="p">:</span><span class="m">#373737</span><span class="p">;</span>
    <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">th</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#B40E1F</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#F0F0F0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">td</span> <span class="p">{</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c">/* Begin font styles */</span>
<span class="nt">h1</span><span class="o">,</span> <span class="nf">#footer</span> <span class="p">{</span>
    <span class="nl">font-family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#F1F3F1</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">h3</span> <span class="p">{</span><span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
 
<span class="c">/* Menu styles */</span>
<span class="nc">.item</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#00728B</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#032472</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#FFF</span><span class="p">;</span>
    <span class="nl">font-family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
    <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nc">.leftpart</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">70%</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nc">.rightpart</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">30%</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nc">.small</span> <span class="p">{</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">75%</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#373737</span><span class="p">;</span>
<span class="p">}</span>
<span class="nf">#footer</span> <span class="p">{</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">65%</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">3px</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nc">.topic-post</span> <span class="p">{</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
    <span class="nl">overflow</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nc">.post-content</span> <span class="p">{</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">30px</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="nt">textarea</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">500px</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">200px</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h1 id="ثالثاً-البدء-بالتنفيذ-الفعلي">ثالثاً: البدء بالتنفيذ الفعلي</h1>

<p>قبل أن نستطيع قراءة أي شيئ من قاعدة البيانات، يجب أن نقيم اتصال بها. وهذا ما سيقوم به ملف connect.php الذي سنضمنه بكل ملف ننشؤه.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//connect.php
</span><span class="nv">$server</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$username</span>   <span class="o">=</span> <span class="s1">'usernamehere'</span><span class="p">;</span>
<span class="nv">$password</span>   <span class="o">=</span> <span class="s1">'passwordhere'</span><span class="p">;</span>
<span class="nv">$database</span>   <span class="o">=</span> <span class="s1">'databasenamehere'</span><span class="p">;</span>
 
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">mysql_connect</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span>  <span class="nv">$password</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">'Error: could not establish database connection'</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">mysql_select_db</span><span class="p">(</span><span class="nv">$database</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">'Error: could not select the database'</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>ببساطة استبدل فقط القيم الافتراضية للمتغيرات في أعلى الكود ببياناتك الخاصة. احفظ الملف ودعنا ننطلق للكملة.</p>

<h1 id="رابعاً-عرض-المنتدى">رابعاً: عرض المنتدى</h1>

<p>بما أننا بدأنا بتقنيات أساسية، سنقوم بعمل طريقة عرض مبسطة للمنتدى الآن.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//create_cat.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
         
<span class="k">echo</span> <span class="s1">'&lt;tr&gt;'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;td class="leftpart"&gt;'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;h3&gt;&lt;a href="category.php?id="&gt;Category name&lt;/a&gt;&lt;/h3&gt; Category description goes here'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;td class="rightpart"&gt;'</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s1">'&lt;a href="topic.php?id="&gt;Topic subject&lt;/a&gt; at 10-10'</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">'&lt;/tr&gt;'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>الآن اكتمل منتداك تقريباً. بفتحك لهذا الملف من السيرفر ستشاهد المنتدى بشكل أنيق وبسيط. سنقوم خلال بقية الشرح بتحديث هذا الملف لنحصل على النتيجة النهائية، خطوة بخطوة!</p>

<h1 id="خامساً-اشتراك-مستخدم">خامساً: اشتراك مستخدم</h1>

<p>دعنا الآن ننشئ نموذج اشتراك بسيط بلغة html حيث يمكن للمستخدمين الاشتراك بالمنتدى</p>

<p><img src="/assets/2.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-2" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-2" /></p>

<p>سنحتاج أيضاً لصفحة بلغة php لإرسال بيانات النموذج لقاعدة البيانات وإتمام اشتراك المستخدم. سنقوم باستخدام المتغير  <code class="highlighter-rouge">$_SERVER</code> .
المتغير <code class="highlighter-rouge">$_SERVER</code> يحوي مجموعة من القيم التي يتم تعيينها تلقائياً مع كل طلب. أحد هذه القيم هو <code class="highlighter-rouge">REQUEST_METHOD</code> . عندما يتم طلب صفحة بواسطة <code class="highlighter-rouge">GET</code> . فسيحمل هذا المتغير القيمة <code class="highlighter-rouge">GET</code> . وعندما يتم طلب الصفحة بواسطة <code class="highlighter-rouge">POST</code> ، فسيحمل المتغير القيمة <code class="highlighter-rouge">POST</code> . ولذا سنستخدم هذا المتغير لمعرفة إذا تم إرسال النموذج (بواسطة <code class="highlighter-rouge">POST</code>). انظر صفحة الاشتراك signup.php أدناه</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//signup.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
 
<span class="k">echo</span> <span class="s1">'&lt;h3&gt;Sign up&lt;/h3&gt;'</span><span class="p">;</span>
 
<span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'POST'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*the form hasn't been posted yet, display it
      note that the action="" will cause the form to post to the same page it is on */</span>
    <span class="k">echo</span> <span class="s1">'&lt;form method="post" action=""&gt;
        Username: &lt;input type="text" name="user_name" /&gt;
        Password: &lt;input type="password" name="user_pass"&gt;
        Password again: &lt;input type="password" name="user_pass_check"&gt;
        E-mail: &lt;input type="email" name="user_email"&gt;
        &lt;input type="submit" value="Add category" /&gt;
     &lt;/form&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="cm">/* so, the form has been posted, we'll process the data in three steps:
        1.  Check the data
        2.  Let the user refill the wrong fields (if necessary)
        3.  Save the data 
    */</span>
    <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span> <span class="cm">/* declare the array for later use */</span>
     
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="c1">//the user name exists
</span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">ctype_alnum</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]))</span>
        <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The username can only contain letters and digits.'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The username cannot be longer than 30 characters.'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The username field must not be empty.'</span><span class="p">;</span>
    <span class="p">}</span>
     
     
    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass'</span><span class="p">]))</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass_check'</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The two passwords did not match.'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The password field cannot be empty.'</span><span class="p">;</span>
    <span class="p">}</span>
     
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="cm">/*check for an empty array, if there are errors, they're in this array (note the ! operator)*/</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'Uh-oh.. a couple of fields are not filled in correctly..'</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'&lt;ul&gt;'</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="cm">/* walk through the array so all the errors get displayed */</span>
        <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'&lt;li&gt;'</span> <span class="o">.</span> <span class="nv">$value</span> <span class="o">.</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span> <span class="cm">/* this generates a nice error list */</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s1">'&lt;/ul&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//the form has been posted without, so save it
</span>        <span class="c1">//notice the use of mysql_real_escape_string, keep everything safe!
</span>        <span class="c1">//also notice the sha1 function which hashes the password
</span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO
                    users(user_name, user_pass, user_email ,user_date, user_level)
                VALUES('"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"',
                       '"</span> <span class="o">.</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"',
                       '"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_email'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"',
                        NOW(),
                        0)"</span><span class="p">;</span>
                         
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//something went wrong, display the error
</span>            <span class="k">echo</span> <span class="s1">'Something went wrong while registering. Please try again later.'</span><span class="p">;</span>
            <span class="c1">//echo mysql_error(); //debugging purposes, uncomment when needed
</span>        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'Successfully registered. You can now &lt;a href="signin.php"&gt;sign in&lt;/a&gt; and start posting! :-)'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>العديد من التوضيحات ستجدها في التعليقات الموضوعة ضمن الكود، لذا تأكد من قراءتها. معالجة البيانات تتم على ثلاثة مراحل:</p>

<h2 id="التأكد-من-البيانات">التأكد من البيانات</h2>

<p>اذا لم تكن البيانات صحيحة ومعبئة بشكل كامل، اعرض النموذج مرة أخرى.
اذا كانت جميع البيانات صحيحة ومعبئة، احفظ البيانات في قاعدة البيانات.</p>

<p>(ماذا تقصد بالتأكد من صحة البيانات اذا كانت البيانات تُدخل ﻷول مرة؟ أقصد بذلك أن هناك حقل مثلاً ليضع المستخدم بريده الإلكتروني، يتم تعريف هذا الحقل بلغة <code class="highlighter-rouge">html</code> على أنه بريد إلكتروني، يجب أن يحوي على <code class="highlighter-rouge">@</code> و نقطة ثم كوم أو نت أو أياً كان، إذا لم تكن البيانات المدخلة في هذا الحقل بالشكل المذكور، فالمستخدم في الواقع لم يدخل بريد إلكتروني فعلاً، وهناك بالتالي بيانات غير صحيحة في النموذج)</p>

<p>الجزء المتعلق بـ php على كل حال يشرح نفسه بنفسه، يبقى تعليمات SQL التي تحتاج بعض الشرح.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span>
       <span class="n">users</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">user_pass</span><span class="p">,</span> <span class="n">user_email</span> <span class="p">,</span><span class="n">user_date</span><span class="p">,</span> <span class="n">user_level</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="s1">'" . mysql_real_escape_string($_POST['</span><span class="n">user_name</span><span class="s1">']) . "'</span><span class="p">,</span>
       <span class="s1">'" . sha1($_POST['</span><span class="n">user_pass</span><span class="s1">']) . "'</span><span class="p">,</span>
       <span class="s1">'" . mysql_real_escape_string($_POST['</span><span class="n">user_email</span><span class="s1">']) . "'</span><span class="p">,</span>
       <span class="n">NOW</span><span class="p">(),</span> 
       <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>في السطر الأول لدينا عبارة <code class="highlighter-rouge">INSERT INTO</code> التي تستخدم لإضافة بيانات لقاعدة البيانات، وتم تحديد اسم الجدول في السطر الثاني. الكلمات التي بين قوسين تحدد أسماء الأعمدة التي نريد إدراج البيانات لها. عبارة VALUES تُخبر قاعدة البيانات أننا انتهينا من تحديد أسماء الأعمدة وجاء وقت تحديد القيم التي ستُضاف لهذه الأعمدة. ولدينا شيئ جديد هنا: <code class="highlighter-rouge">mysql_real_escape_string</code>. تستخدم هذه التعليمة لحماية بيانات المستخدم أثناء إرساله للنموذج، ويجب أن تُستخدم دائماً باستثاء بعض الحالات النادرة. السكريبتات التي لا تستخدم هذه التعليمة يكون اختراقها والوصول لبيانات النموذج المرسلة سهل جداً، فلا تخاطر بذلك واستخدم عبارة <code class="highlighter-rouge">mysql_real_escape_string()</code>.</p>

<blockquote>
  <p>إيّاك أن تُدرج كلمة السر في قاعدة البيانات كما هي. يجب عليك دائماً تشفيرها.</p>
</blockquote>

<p>كما رأيت ، لقد قمنا باستخدام عبارة <code class="highlighter-rouge">sha1()</code> لتشفير كلمة سر المستخدم قبل حفظها في قاعدة البيانات، تذكر دائماً عمل هذه الخطوة في كل نموذج تقوم بعمله ويحوي على كلمة سر. فلو فرضنا أن أحد المخترقين قام بالوصول لقاعدة البيانات، وكانت كلمات السر غير مشفرة، فسيصبح بإمكانه الولوج لحساب أي مستخدم أو أي مدير في المنتدى وعمل ما يحلو له، أما لو كانت كلمات السر مشفرة فلن يتمكن من فعل ذلك قبل أن يفك تشفيرهم، وهذا مستحيل تقريباً .</p>

<blockquote>
  <p>من الممكن استخدام أي نوع تشفير آخر بدلاً من <code class="highlighter-rouge">sha1()</code> ، مثل <code class="highlighter-rouge">md5()</code> . أنا استخدم النوع <code class="highlighter-rouge">sha1()</code> ﻷن المقاييس أثبتت أن هذا النوع أسرع بقليل.</p>
</blockquote>

<p>اذا نجحت عملية الاشتراك فستحصل على التالي</p>

<p><img src="/assets/3.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-3" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-3" /></p>

<p>قم بتحديث صفحة قاعدة البيانات في phpMyAdmin ، يجب أن ترى تسجيلاً جديداً في جدول المستخدمين users</p>

<h1 id="سادساً-إضافة-التفعيل-ومستوى-المستخدم">سادساً: إضافة التفعيل ومستوى المستخدم</h1>

<p>إن من المزايا الهامة في المنتدى هو الفرق بين المستخدم العادي والمدير/المشرف. وبما أننا نناقش هنا منتجى صغير وبسيط وأن إضافة مزايا سيأخذ وقتاً طويلاً، فسنركز هنا على عملية تسجيل الدخول وإضافة بعض المزايا للمدراء مثل إضافة تصنيفات جديدة وإغلاق نقاش.</p>

<p>والآن بعد إكمال الخطوة السابقة، سنقوم بجعل الحساب الذي أنشأته للتو حساب مدير. اذهب لـ phpMyAdmin واضغط على جدول المستخدمين users ثم اضغط على خيار Browse . سيظهر لك الحساب الذي أنشأته، اضغط على أيقونة التعديل edit وقم بتغيير قيمة الحقل <code class="highlighter-rouge">user_level</code> من 0 إلى 1 .</p>

<p>حالياً لن تلاحظ أي فرق في المنتدى، ولكن عندما نضيف مزايا المدير سيصبح هناك فروقات في الصلاحيات بين الحساب العادي وهذا الحساب.</p>

<p><strong>عملية تسجيل الدخول تعمل كالتالي:</strong></p>

<ul>
  <li>
    <p>يقوم الزائر بإدخال بيانات المستخدم ويرسل النموذج.</p>
  </li>
  <li>
    <p>إذا كان اسم المستخدم وكلمة السر المدخلين صحيحين، فيمكن الآن بدء الجلسة (session)
اذا كان اسم المستخدم أو كلمة المرور غير صحيحين، نقوم بإظهار النموذج مرة أخرى مع رسالة خطأ.</p>
  </li>
</ul>

<p><img src="/assets/6.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-4" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-4" /></p>

<p>بالأسفل ملف تسجيل الدخول signin.php . اطلع على التعليقات ضمن الكود لفهم ما يجري</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"> 

<span class="cp">&lt;?php</span>
<span class="c1">//signin.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
 
<span class="k">echo</span> <span class="s1">'&lt;h3&gt;Sign in&lt;/h3&gt;'</span><span class="p">;</span>
 
<span class="c1">//first, check if the user is already signed in. If that is the case, there is no need to display this page
</span><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'You are already signed in, you can &lt;a href="signout.php"&gt;sign out&lt;/a&gt; if you want.'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'POST'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/*the form hasn't been posted yet, display it
          note that the action="" will cause the form to post to the same page it is on */</span>
        <span class="k">echo</span> <span class="s1">'&lt;form method="post" action=""&gt;
            Username: &lt;input type="text" name="user_name" /&gt;
            Password: &lt;input type="password" name="user_pass"&gt;
            &lt;input type="submit" value="Sign in" /&gt;
         &lt;/form&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/* so, the form has been posted, we'll process the data in three steps:
            1.  Check the data
            2.  Let the user refill the wrong fields (if necessary)
            3.  Varify if the data is correct and return the correct response
        */</span>
        <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span> <span class="cm">/* declare the array for later use */</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]))</span>
        <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The username field must not be empty.'</span><span class="p">;</span>
        <span class="p">}</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass'</span><span class="p">]))</span>
        <span class="p">{</span>
            <span class="nv">$errors</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'The password field must not be empty.'</span><span class="p">;</span>
        <span class="p">}</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span> <span class="cm">/*check for an empty array, if there are errors, they're in this array (note the ! operator)*/</span>
        <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'Uh-oh.. a couple of fields are not filled in correctly..'</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s1">'&lt;ul&gt;'</span><span class="p">;</span>
            <span class="k">foreach</span><span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="cm">/* walk through the array so all the errors get displayed */</span>
            <span class="p">{</span>
                <span class="k">echo</span> <span class="s1">'&lt;li&gt;'</span> <span class="o">.</span> <span class="nv">$value</span> <span class="o">.</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">;</span> <span class="cm">/* this generates a nice error list */</span>
            <span class="p">}</span>
            <span class="k">echo</span> <span class="s1">'&lt;/ul&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">//the form has been posted without errors, so save it
</span>            <span class="c1">//notice the use of mysql_real_escape_string, keep everything safe!
</span>            <span class="c1">//also notice the sha1 function which hashes the password
</span>            <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT 
                        user_id,
                        user_name,
                        user_level
                    FROM
                        users
                    WHERE
                        user_name = '"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"'
                    AND
                        user_pass = '"</span> <span class="o">.</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user_pass'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">;</span>
                         
            <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//something went wrong, display the error
</span>                <span class="k">echo</span> <span class="s1">'Something went wrong while signing in. Please try again later.'</span><span class="p">;</span>
                <span class="c1">//echo mysql_error(); //debugging purposes, uncomment when needed
</span>            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">//the query was successfully executed, there are 2 possibilities
</span>                <span class="c1">//1. the query returned data, the user can be signed in
</span>                <span class="c1">//2. the query returned an empty result set, the credentials were wrong
</span>                <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">echo</span> <span class="s1">'You have supplied a wrong user/password combination. Please try again.'</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">//set the $_SESSION['signed_in'] variable to TRUE
</span>                    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                     
                    <span class="c1">//we also put the user_id and user_name values in the $_SESSION, so we can use it at various pages
</span>                    <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span>    <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">];</span>
                        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span>  <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">];</span>
                        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_level'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'user_level'</span><span class="p">];</span>
                    <span class="p">}</span>
                     
                    <span class="k">echo</span> <span class="s1">'Welcome, '</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'. &lt;a href="index.php"&gt;Proceed to the forum overview&lt;/a&gt;.'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>كما لاحظت، هذه هي تعليمات SQL في الكود السابق</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> 

<span class="k">SELECT</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="n">user_name</span><span class="p">,</span>
    <span class="n">user_level</span>
<span class="k">FROM</span>
    <span class="n">users</span>
<span class="k">WHERE</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="s1">'" . mysql_real_escape_string($_POST['</span><span class="n">user_name</span><span class="s1">']) . "'</span>
<span class="k">AND</span>
    <span class="n">user_pass</span> <span class="o">=</span> <span class="s1">'" . sha1($_POST['</span><span class="n">user_pass</span><span class="s1">'])</span></code></pre></figure>

<p>من الواضح أننا نقوم بالتأكد من البيانات المدخلة إذا كانت لمستخدم موجود بالفعل. هناك العديد من السكريبتات التي تستخرج كلمة السر من قاعدة البيانات وتقارنها مع تلك المدخلة في النموذج باستخدام php. ولكن القيام بذلك بواسطة تعليمات SQL مباشرة سيجعل العملية أكثر أمناً حيث أن العملية هذه تحصل في وسط قاعدة البيانات وليس ضمن تطبيقنا الوب (منتدانا).</p>

<p>إذا قام المستخدم بتسجيل الدخول بشكل صحيح، فسنقوم بعمل بضعة أشياء:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"> 

<span class="cp">&lt;?php</span>
<span class="c1">//set the $_SESSION['signed_in'] variable to TRUE
</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="c1">//we also put the user_id and user_name values in the $_SESSION, so we can use it at various pages
</span><span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
<span class="p">{</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">];</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">];</span> 
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>في البداية، قمنا بإعطاء المتغير <code class="highlighter-rouge">$_SESSION['signed_in']</code>  القيمة <code class="highlighter-rouge">true</code> أي أننا بدأنا الجلسة والمستخدم الآن مسجل الدخول. وسنقوم باستخدام هذا المتغير في صفحات أخرى للتأكد من أن المستخدم مسجل الدخول. أيضاً قمنا بوضع اسم المستخدم <code class="highlighter-rouge">username</code> ومعرفه <code class="highlighter-rouge">user_id</code> في المتغير <code class="highlighter-rouge">$_SESSION</code> للاستخدام في صفحات أخرى. أخيراً، سنقوم بعرض رابط لرئيسية المنتدى حيث يمكن للمستخدم البدء في الإبحار.</p>

<p>تسجيل الدخول بالطبع يتطلب وظيفة أخرى وهي تسجيل الخروج! في الواقع عملية تسجيل الخروج أسهل بكثير من عملية تسجيل الدخول، فبما أن جميع المعلومات مخزنة في متغيرات <code class="highlighter-rouge">$_SESSION</code> ، فكل ما علينا فعله هو إلغاء تعيينهم في هذا المتغير وعرض رسالة للمستخدم.</p>

<p>الآن قمنا بضبط متغيرات <code class="highlighter-rouge">$_SESSION</code> ، يمكننا تحديد اذا كان شخص ما مسجل الدخول. دعنا نقوم الآن بعمل تغيير أخير على ملف الترويسة header.php
قم باستبدال التالي في الملف:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"userbar"</span><span class="nt">&gt;</span>Hello Example. Not you? Log out.<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<p>إلى :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"> 

<span class="cp">&lt;?php</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"userbar"</span><span class="o">&gt;</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'Hello'</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'. Not you? &lt;a href="signout.php"&gt;Sign out&lt;/a&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'&lt;a href="signin.php"&gt;Sign in&lt;/a&gt; or &lt;a href="sign up"&gt;create an account&lt;/a&gt;.'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span></code></pre></figure>

<p>وبالتالي، إذا قام المستخدم بتسجيل الدخول، فسيرى اسمه معروض في بداية الصفحة مع رابط لصفحة تسجيل الخروج.</p>

<p>نجحت طريقة التفعيل! والآن يبدو منتدانا كالتالي :</p>

<p><img src="/assets/4.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-5" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-5" /></p>

<h1 id="سابعاً-إنشاء-تصنيف">سابعاً: إنشاء تصنيف</h1>

<p>نحن نريد إنشاء تصانيف في المنتدى، لذا دعنا ننشئ نموذج لهذه العملية</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
    Category name: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"cat_name"</span> <span class="nt">/&gt;</span>
    Category description: <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"cat_description"</span> <span class="nt">/&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add category"</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/form&gt;</span></code></pre></figure>

<p>تبدو هذه الخطوة مثل الخطوة الرابعة (اشتراك مستخدم). لذا لن أقوم بالشرح هنا ، فبما أنك متابع للخطوات فستكون قادراً على فهم الأمور بشكل سريع.</p>

<p>سنقوم تضمين النموذج في الأعلى ضمن صفحة إنشاء تصنيف :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//create_cat.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
 
<span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'POST'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//the form hasn't been posted yet, display it
</span>    <span class="k">echo</span> <span class="s1">'&lt;form method='</span><span class="nx">post</span><span class="s1">' action=''&gt;
        Category name: &lt;input type='</span><span class="nx">text</span><span class="s1">' name='</span><span class="nx">cat_name</span><span class="s1">' /&gt;
        Category description: &lt;textarea name='</span><span class="nx">cat_description</span><span class="s1">' /&gt;&lt;/textarea&gt;
        &lt;input type='</span><span class="nx">submit</span><span class="s1">' value='</span><span class="nx">Add</span> <span class="nx">category</span><span class="s1">' /&gt;
     &lt;/form&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//the form has been posted, so save it
</span>    <span class="nv">$sql</span> <span class="o">=</span> <span class="err">ì</span><span class="nx">INSERT</span> <span class="nx">INTO</span> <span class="nx">categories</span><span class="p">(</span><span class="nx">cat_name</span><span class="p">,</span> <span class="nx">cat_description</span><span class="p">)</span>
       <span class="nx">VALUES</span><span class="p">(</span><span class="s1">''</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cat_name'</span><span class="p">])</span> <span class="o">.</span> <span class="err">ì</span><span class="s1">',
             '' . mysql_real_escape_string($_POST['</span><span class="nx">cat_description</span><span class="s1">']) . ì'</span><span class="p">)</span><span class="s1">';
    $result = mysql_query($sql);
    if(!$result)
    {
        //something went wrong, display the error
        echo '</span><span class="nx">Error</span><span class="s1">' . mysql_error();
    }
    else
    {
        echo '</span><span class="nx">New</span> <span class="nx">category</span> <span class="nx">successfully</span> <span class="nx">added</span><span class="o">.</span><span class="err">'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>وكما ترى، لقد بدأنا السكريبت بفحص السيرفر $_SERVER ، بعد التأكد من أن المستخدم لديه صلاحيات المدير، والمطلوبة لإنشاء تصنيف، يتم عرض النموذج إذا لم يتم تعبئته وإرساله سابقاً، وإذا تم إرساله، يتم حفظ القيم. مرة أخرى ، يتم تحضير تعليمة SQL وتنفيذها.</p>

<p><img src="/assets/5.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-6" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-6" /></p>

<h1 id="ثامناً-إضافة-تصنيفات-للصفحة-الرئيسية-indexphp">ثامناً: إضافة تصنيفات للصفحة الرئيسية index.php</h1>

<p>لقد قمنا بإنشاء بعض التصنيفات، ويمكننا الآن عرضهم في الصفحة الرئيسية. دعنا نضيف تعليمة SQL التالية لمنظقة المحتوى في الصفحة الرئيسية index.php</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
    <span class="n">categories</span><span class="p">.</span><span class="n">cat_id</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">.</span><span class="n">cat_name</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">.</span><span class="n">cat_description</span><span class="p">,</span>
<span class="k">FROM</span>
    <span class="n">categories</span></code></pre></figure>

<p>تقوم هذه التعليمة بتحديد جميع التصنيفات وأسمائهم ووصفهم من جدول التصنيفات. سنحتاج الآن لبضعة أسطر php لعرض النتائج. إذا قمنا بإضافة التعليمة كما فعلنا في الخطوات السابقة، فسيبدو الكود على الشكل:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//create_cat.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
 
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT
            cat_id,
            cat_name,
            cat_description,
        FROM
            categories"</span><span class="p">;</span>
 
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
 
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'The categories could not be displayed, please try again later.'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'No categories defined yet.'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//prepare the table
</span>        <span class="k">echo</span> <span class="s1">'&lt;table border="1"&gt;
              &lt;tr&gt;
                &lt;th&gt;Category&lt;/th&gt;
                &lt;th&gt;Last topic&lt;/th&gt;
              &lt;/tr&gt;'</span><span class="p">;</span> 
             
        <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
        <span class="p">{</span>               
            <span class="k">echo</span> <span class="s1">'&lt;tr&gt;'</span><span class="p">;</span>
                <span class="k">echo</span> <span class="s1">'&lt;td class="leftpart"&gt;'</span><span class="p">;</span>
                    <span class="k">echo</span> <span class="s1">'&lt;h3&gt;&lt;a href="category.php?id"&gt;'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'cat_name'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;&lt;/h3&gt;'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'cat_description'</span><span class="p">];</span>
                <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
                <span class="k">echo</span> <span class="s1">'&lt;td class="rightpart"&gt;'</span><span class="p">;</span>
                            <span class="k">echo</span> <span class="s1">'&lt;a href="topic.php?id="&gt;Topic subject&lt;/a&gt; at 10-10'</span><span class="p">;</span>
                <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
            <span class="k">echo</span> <span class="s1">'&lt;/tr&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>لاحظ كيف استخدمنا حقل cat_id لإنشاء روابط لصفحة category.php . جميع الروابط لهذه السفحة ستبدو على الشكل:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>	category.php?cat_id=x
</code></pre>
</div>

<p>حيث x يمكن أن يكون أي قيمة عددية بحسب التصنيف .</p>

<h1 id="تاسعاً-إنشاء-موضوع">تاسعاً: إنشاء موضوع</h1>

<p>سنقوم في هذه الخطوة بجمع التقنيات التي تعلمناها في الخطوات السابقة. حيث سنقوم بالتأكد من أن المستخدم مسجل الدخول، سنقوم باستخدام تعليمة SQL لإنشاء موضوع ، وسننشئ نموذج html بسيط كواجهة مستخدم لإنشاء الموضوع.</p>

<p>إن هيكلية ملف إنشاء الموضوع create_topic.php من الصعب شرحها ضمن قائمة أو ما شابه، لذا قمت بكتابة شرح للهيكل العام للملف كتوضيح:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="nx">is</span> <span class="nx">signed</span> <span class="nx">in</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//the user is not signed in
</span><span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//the user is signed in
</span>    <span class="k">if</span><span class="p">(</span><span class="nx">form</span> <span class="nx">has</span> <span class="k">not</span> <span class="nx">been</span> <span class="nx">posted</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//show form
</span>    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//process form
</span>    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>وهذا هو الكود الحقيقي لهذا القسم من المنتدى ، راجع الشرح أسفل الكود لفهم ما يجري .</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//create_cat.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
 
<span class="k">echo</span> <span class="s1">'&lt;h2&gt;Create a topic&lt;/h2&gt;'</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">]</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//the user is not signed in
</span>    <span class="k">echo</span> <span class="s1">'Sorry, you have to be &lt;a href="/forum/signin.php"&gt;signed in&lt;/a&gt; to create a topic.'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//the user is signed in
</span>    <span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'POST'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//the form hasn't been posted yet, display it
</span>        <span class="c1">//retrieve the categories from the database for use in the dropdown
</span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT
                    cat_id,
                    cat_name,
                    cat_description
                FROM
                    categories"</span><span class="p">;</span>
         
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//the query failed, uh-oh :-(
</span>            <span class="k">echo</span> <span class="s1">'Error while selecting from database. Please try again later.'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//there are no categories, so a topic can't be posted
</span>                <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_level'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">echo</span> <span class="s1">'You have not created categories yet.'</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="k">echo</span> <span class="s1">'Before you can post a topic, you must wait for an admin to create some categories.'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
         
                <span class="k">echo</span> <span class="s1">'&lt;form method="post" action=""&gt;
                    Subject: &lt;input type="text" name="topic_subject" /&gt;
                    Category:'</span><span class="p">;</span> 
                 
                <span class="k">echo</span> <span class="s1">'&lt;select name="topic_cat"&gt;'</span><span class="p">;</span>
                    <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">echo</span> <span class="s1">'&lt;option value="'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'cat_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'cat_name'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'&lt;/option&gt;'</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="k">echo</span> <span class="s1">'&lt;/select&gt;'</span><span class="p">;</span> 
                     
                <span class="k">echo</span> <span class="s1">'Message: &lt;textarea name="post_content" /&gt;&lt;/textarea&gt;
                    &lt;input type="submit" value="Create topic" /&gt;
                 &lt;/form&gt;'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//start the transaction
</span>        <span class="nv">$query</span>  <span class="o">=</span> <span class="s2">"BEGIN WORK;"</span><span class="p">;</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Damn! the query failed, quit
</span>            <span class="k">echo</span> <span class="s1">'An error occured while creating your topic. Please try again later.'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
     
            <span class="c1">//the form has been posted, so save it
</span>            <span class="c1">//insert the topic into the topics table first, then we'll save the post into the posts table
</span>            <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO 
                        topics(topic_subject,
                               topic_date,
                               topic_cat,
                               topic_by)
                   VALUES('"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'topic_subject'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"',
                               NOW(),
                               "</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'topic_cat'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">",
                               "</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"
                               )"</span><span class="p">;</span>
                      
            <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//something went wrong, display the error
</span>                <span class="k">echo</span> <span class="s1">'An error occured while inserting your data. Please try again later.'</span> <span class="o">.</span> <span class="nb">mysql_error</span><span class="p">();</span>
                <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"ROLLBACK;"</span><span class="p">;</span>
                <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">//the first query worked, now start the second, posts query
</span>                <span class="c1">//retrieve the id of the freshly created topic for usage in the posts query
</span>                <span class="nv">$topicid</span> <span class="o">=</span> <span class="nb">mysql_insert_id</span><span class="p">();</span>
                 
                <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO
                            posts(post_content,
                                  post_date,
                                  post_topic,
                                  post_by)
                        VALUES
                            ('"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'post_content'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"',
                                  NOW(),
                                  "</span> <span class="o">.</span> <span class="nv">$topicid</span> <span class="o">.</span> <span class="s2">",
                                  "</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"
                            )"</span><span class="p">;</span>
                <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
                 
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//something went wrong, display the error
</span>                    <span class="k">echo</span> <span class="s1">'An error occured while inserting your post. Please try again later.'</span> <span class="o">.</span> <span class="nb">mysql_error</span><span class="p">();</span>
                    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"ROLLBACK;"</span><span class="p">;</span>
                    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"COMMIT;"</span><span class="p">;</span>
                    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
                     
                    <span class="c1">//after a lot of work, the query succeeded!
</span>                    <span class="k">echo</span> <span class="s1">'You have successfully created &lt;a href="topic.php?id='</span><span class="o">.</span> <span class="nv">$topicid</span> <span class="o">.</span> <span class="s1">'"&gt;your new topic&lt;/a&gt;.'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>سأناقش هذه الصفحة على قسمين: عرض النموذج ومعالجة النموذج.</p>

<h2 id="عرض-النموذج">عرض النموذج</h2>

<p>لعرض النموذج فإننا نبدأ بتعليمات html بسيطة، ولكن في الواقع هناك شيئ خاص، ﻷننا نستخدم قائمة منسدلة، هذه القائمة المنسدلة يتم تعبئتها من خلال بيانات موجودة في قاعدة البيانات، يتم استخراج تلك البيانات باستخدام تعليمات SQL :</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
    <span class="n">cat_id</span><span class="p">,</span>
    <span class="n">cat_name</span><span class="p">,</span>
    <span class="n">cat_description</span>
<span class="k">FROM</span>
    <span class="n">categories</span></code></pre></figure>

<p>أعتقد أن هذا هو الجزء الغير واضح هنا، والآن كما ترى هو مجرد كود بسيط .</p>

<h2 id="معالجة-النموذج">معالجة النموذج</h2>

<p>عملية حفظ الموضوع تتضمن مرحلتين: حفظ الموضوع في جدول المواضيع ضمن قاعدة البيانات، وحفظ أول تعليق في جدول التعليقات. وهذا يتطلب شيئ متقدم نوعاً ما وخارج موضوعنا هنا تقريباً، وهو يدعى إجراء <code class="highlighter-rouge">transaction</code> ، ويُقصد به أننا نبدأ بتنفيذ أمر البدء ثم التراجع إذا كان هناك أخطاء في قاعدة البيانات أو إنهاء التنفيذ عندما يجري كل شيئ بشكل صحيح.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//start the transaction
</span><span class="nv">$query</span>  <span class="o">=</span> <span class="s2">"BEGIN WORK;"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
<span class="c1">//stop the transaction
</span><span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"ROLLBACK;"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="c1">//commit the transaction
</span><span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"COMMIT;"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>أول تعليمة تستخدم لحفظ ابيانات هو تعليمة إنشاء موضوع، والتي تبدو على الشكل التالي :</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span>
    <span class="n">topics</span><span class="p">(</span><span class="n">topic_subject</span><span class="p">,</span>
               <span class="n">topic_date</span><span class="p">,</span>
               <span class="n">topic_cat</span><span class="p">,</span>
               <span class="n">topic_by</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="s1">'" . mysql_real_escape_string($_POST['</span><span class="n">topic_subject</span><span class="s1">']) . "'</span><span class="p">,</span>
       <span class="n">NOW</span><span class="p">(),</span>
       <span class="nv">" . mysql_real_escape_string($_POST['topic_cat']) . "</span><span class="p">,</span>
       <span class="nv">" . $_SESSION['user_id'] . "</span><span class="p">)</span></code></pre></figure>

<p>في البداية تم تعريف الحقول، ثم القيم ليتم إدراجها في الحقول. لقد رأيت مثل هذه التعليمات سابقاً، حيث أنها مجرد تعليمات يتم تأمينها استخدام العبارة <code class="highlighter-rouge">musql_real_escape_string()</code> . القيمة الثانية : <code class="highlighter-rouge">NOW()</code> هي وظيفة في <code class="highlighter-rouge">SQL</code> لإدارج الوقت الحالي. القيمة الثالثة هي التي لم ترها من قبل، وهي تشير إلى معرف id صالح لتصنيف ما. والقيمة الأخيرة تشير لمعرف id مستخدم موجود بالفعل، وهو في حالتنا هي قيمة المتغير <code class="highlighter-rouge">$_SESSION['user_id']</code>.  خيث تم مناقشة هذا المتغير خلال خطوة تسجيل الدخول .</p>

<p>إذا تم تنفيذ الكود بدون أخطاء، فيتم الانتقال للخطوة التالية. تذكر أننا ما زالنا نجري إجراءاً هنا <code class="highlighter-rouge">transaction</code> . إذا حصلنا على أخطاء فسنستخدم تعليمة <code class="highlighter-rouge">ROLLBACK</code>.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span>
        <span class="n">posts</span><span class="p">(</span><span class="n">post_content</span><span class="p">,</span>
        <span class="n">post_date</span><span class="p">,</span>
        <span class="n">post_topic</span><span class="p">,</span>
        <span class="n">post_by</span><span class="p">)</span>
<span class="k">VALUES</span>
        <span class="p">(</span><span class="s1">'" . mysql_real_escape_string($_POST['</span><span class="n">post_content</span><span class="s1">']) . "'</span><span class="p">,</span>
         <span class="n">NOW</span><span class="p">(),</span>
         <span class="nv">" . $topicid . "</span><span class="p">,</span>
         <span class="nv">" . $_SESSION['user_id'] . "</span><span class="p">)</span></code></pre></figure>

<p>إن أول شيئ نفعله هنا هو استخدام تعليمة <code class="highlighter-rouge">mysql_insert_id()</code> للحصول على آخر id تم توليده من حقل <code class="highlighter-rouge">topic_id</code> في جدول المواضيع. وكما وجدت في الخطوات الأولى، يتم توليد الـ <code class="highlighter-rouge">id</code> في قاعدة البيانات باستخدام تعليمة <code class="highlighter-rouge">auto_increment</code>.</p>

<p>ثم يتم إدراج المنشور في جدول المنشورات post table. تبدو هذه العملية مشابهة لعملية المواضيع، الفرق الوحيد بينهما هو أن المنشور يشير إلى الموضوع والموضوع يشير للتصنيف. لقد قررنا من البداية إنشاء تصميم بيانات جيد، وهذه هي النتيجة.</p>

<p><img src="/assets/7.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-7" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-7" /></p>

<h1 id="عاشراً--عرض-التصنيفات">عاشراً : عرض التصنيفات</h1>

<p>سوف نقوم بعمل صفحة عرض لتصنيف محدد. لقد أنشأنا تصنيفاً للتو ، ومن المفضل توفير إمكانية مشاهدة جميع المواضيع التي تتبع لهذا التصنيف. أولاً قم بإنشاء صفحة باسم category.php</p>

<p><strong>نحتاج هنا لعدة أمور:</strong></p>

<p>1.أمور نحتاجها لعرض التصنيف:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">cat_name</code> (اسم التصنيف)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">cat_description</code> (وصف التصنيف)</p>
  </li>
</ul>

<p>2.أمور نحتاجها لعرض المواضيع ضمن ذلك التصنيف:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">topic_id</code>   (معرف الموضوع)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">topic_subject</code>  (عنوان الموضوع)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">topic_date</code>  (تاريخ الموضوع)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">topic_cat</code>   (تصنيف الموضوع)</p>
  </li>
</ul>

<p>لنقم الآن بإنشاء تعليمتي SQL والتي تقوم باستخراج البيانات الني نريدها تحديداً من قاعدة البيانات</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
    <span class="n">cat_id</span><span class="p">,</span>
    <span class="n">cat_name</span><span class="p">,</span>
    <span class="n">cat_description</span>
<span class="k">FROM</span>
    <span class="n">categories</span>
<span class="k">WHERE</span>
    <span class="n">cat_id</span> <span class="o">=</span> <span class="nv">" . mysql_real_escape_string($_GET['id'])</span></code></pre></figure>

<p>تقوم التعليمة أعلاه باستخراج جميع التصنيفات من قاعدة البيانات</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> 
    <span class="n">topic_id</span><span class="p">,</span>
    <span class="n">topic_subject</span><span class="p">,</span>
    <span class="n">topic_date</span><span class="p">,</span>
    <span class="n">topic_cat</span>
<span class="k">FROM</span>
    <span class="n">topics</span>
<span class="k">WHERE</span>
    <span class="n">topic_cat</span> <span class="o">=</span> <span class="nv">" . mysql_real_escape_string($_GET['id'])</span></code></pre></figure>

<p>والآن ، الكود الكامل لملف category.php سيكون على الشكل التالي</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//create_cat.php
</span><span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
 
<span class="c1">//first select the category based on $_GET['cat_id']
</span><span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT
            cat_id,
            cat_name,
            cat_description
        FROM
            categories
        WHERE
            cat_id = "</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
 
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
 
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'The category could not be displayed, please try again later.'</span> <span class="o">.</span> <span class="nb">mysql_error</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'This category does not exist.'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//display category data
</span>        <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'&lt;h2&gt;Topics in ′'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'cat_name'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'′ category&lt;/h2&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
     
        <span class="c1">//do a query for the topics
</span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT  
                    topic_id,
                    topic_subject,
                    topic_date,
                    topic_cat
                FROM
                    topics
                WHERE
                    topic_cat = "</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
         
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
         
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'The topics could not be displayed, please try again later.'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">echo</span> <span class="s1">'There are no topics in this category yet.'</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">//prepare the table
</span>                <span class="k">echo</span> <span class="s1">'&lt;table border="1"&gt;
                      &lt;tr&gt;
                        &lt;th&gt;Topic&lt;/th&gt;
                        &lt;th&gt;Created at&lt;/th&gt;
                      &lt;/tr&gt;'</span><span class="p">;</span> 
                     
                <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
                <span class="p">{</span>               
                    <span class="k">echo</span> <span class="s1">'&lt;tr&gt;'</span><span class="p">;</span>
                        <span class="k">echo</span> <span class="s1">'&lt;td class="leftpart"&gt;'</span><span class="p">;</span>
                            <span class="k">echo</span> <span class="s1">'&lt;h3&gt;&lt;a href="topic.php?id='</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'topic_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'topic_subject'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;&lt;h3&gt;'</span><span class="p">;</span>
                        <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
                        <span class="k">echo</span> <span class="s1">'&lt;td class="rightpart"&gt;'</span><span class="p">;</span>
                            <span class="k">echo</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'d-m-Y'</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'topic_date'</span><span class="p">]));</span>
                        <span class="k">echo</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">;</span>
                    <span class="k">echo</span> <span class="s1">'&lt;/tr&gt;'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>وهذه هي النتيجة النهائية لصفحة التصنيفات</p>

<p><img src="/assets/8.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-8" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-8" /></p>

<h1 id="الخطوة-11--عرض-المواضيع">الخطوة 11 : عرض المواضيع</h1>

<p>إن تعليمات SQL في هذه الخطوة هي تعليمات معقدة. بالنسبة لكود php فسيكون كله مألوفاً لديك وشبيه بما سبق. لذا دعنا نلقي نظرة الآن على تعليمات SQL . حيث التعليمة الأولى تستخرج معلومات أساسية حول الموضوع:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
<span class="n">topic_id</span><span class="p">,</span>
<span class="n">topic_subject</span>
<span class="k">FROM</span>
<span class="n">topics</span>
<span class="k">WHERE</span>
<span class="n">topics</span><span class="p">.</span><span class="n">topic_id</span> <span class="o">=</span> <span class="nv">" . mysql_real_escape_string($_GET[
'id'])</span></code></pre></figure>

<p>يتم عرض هذه المعلومات في رأس الجدول الذي سنستخدمه لعرض جميع البيانات. ثم سنستخرج جميع التعليقات على هذا الموضوع من قاعدة البيانات. التعليمة التالية تعطينا تماماً ما نريد:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_topic</span><span class="p">,</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_content</span><span class="p">,</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_date</span><span class="p">,</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_by</span><span class="p">,</span>
<span class="n">users</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="n">users</span><span class="p">.</span><span class="n">user_name</span>
<span class="k">FROM</span>
<span class="n">posts</span>
<span class="k">LEFT</span> <span class="k">JOIN</span>
<span class="n">users</span>
<span class="k">ON</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_by</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">WHERE</span>
<span class="n">posts</span><span class="p">.</span><span class="n">post_topic</span> <span class="o">=</span> <span class="nv">" . mysql_real_escape_string($_GET[
'id'])</span></code></pre></figure>

<p>والآن نريد معلومات من جدول المستخدمين users وجدول التعليقات replies لذا سنستخدم عبارة LEFT JOIN مرة أخرى. حيث يكون الشرط كالتالي: معرف المستخدم user id يجب أن يكون نفسه في حقل reply_by (مؤلف التعليق) . وبهذه الطريقة نستطيع عرض اسم المستخدم للمستخدم الذي قام بإضافة تعليق ما.</p>

<p>العرض الأخير للمواضيع سيبدو على الشكل :</p>

<p><img src="/assets/9.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-9" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-9" /></p>

<h1 id="الخطوة-12--إضافة-تعليق">الخطوة 12 : إضافة تعليق</h1>

<p>والآن دعنا ننهي آخر جزء متبقي لدينا من المنتدى، ألا وهو إمكانية إضافة تعليق. سنبدأ بعمل نموذج للتعليق (بلغة html) :</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"reply.php?id=5"</span><span class="nt">&gt;</span>
<span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"reply-content"</span><span class="nt">&gt;&lt;/textarea &gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit reply"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></figure>

<p><img src="/assets/10.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-10" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-10" /></p>

<p>وفي النهاية سيكون الكود الكامل لملف reply.php كالتالي:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php">		<span class="cp">&lt;?php</span>
		<span class="c1">//create_cat.php
</span>		<span class="k">include</span> <span class="s1">'connect.php'</span><span class="p">;</span>
		<span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'POST'</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//someone is calling the file directly, which we don't want
</span>			<span class="k">echo</span> <span class="s1">'This file cannot be called directly.'</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="c1">//check for sign in status
</span>			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'signed_in'</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="k">echo</span> <span class="s1">'You must be signed in to post a reply.'</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="c1">//a real user posted a real reply
</span>				<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO 
							posts(post_content,
									post_date,
									post_topic,
									post_by) 
						VALUES ('"</span> <span class="o">.</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'reply-content'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"',
								NOW(),
								"</span> <span class="o">.</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">",
								"</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_id'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">")"</span><span class="p">;</span>
						
				<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">echo</span> <span class="s1">'Your reply has not been saved, please try again later.'</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">echo</span> <span class="s1">'Your reply has been saved, check out &lt;a href="topic.php?id='</span> <span class="o">.</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span> <span class="o">.</span> <span class="s1">'"&gt;the topic&lt;/a&gt;.'</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">include</span> <span class="s1">'footer.php'</span><span class="p">;</span>
		<span class="cp">?&gt;</span></code></pre></figure>

<p>انظر التعليقات ضمن الكود لفهم ما يجري.</p>

<p>نتأكد أولاً من وجود المستخدم ثم نضيف (ندرج) التعليق لقاعدة البيانات.</p>

<p><img src="/assets/11.png" alt="كيفية عمل منتدى باستخدام php و MySQL من الصفر-11" title="كيفية عمل منتدى باستخدام php و MySQL من الصفر-11" /></p>

<h1 id="النهاية">النهاية</h1>

<p>الآن وبعد قراءتك لهذا الشرح ستكون لديك المعرفة الكافية لبناء منتدى، أتمنى أن يكون الشرح واضحاً وأنك لم تعترك مع أية مشاكل في طريقك ..</p>

</div>


<div class="share-page">
    إن أعجبك الشرح فيرجى مشاركته &larr;
    <a href="https://plus.google.com/share?url=http://localhost:4000/php-forum-from-scratch" rel="nofollow" target="_blank" title="Share on Google+">Google+</a>&nbsp&nbsp&nbsp
    <a href="https://twitter.com/intent/tweet?text=إنشاء منتدى PHP من الصفر&url=http://localhost:4000/php-forum-from-scratch&via=&related=" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a>&nbsp&nbsp&nbsp
    <a href="https://facebook.com/sharer.php?u=http://localhost:4000/php-forum-from-scratch" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
</div>


<br>
<font color='#34522'><b>
لمناقشة هذا الموضوع يرجى بدء مناقشة جديدة <a href='https://github.com/Mulham/mulham.github.io/issues'>هنا</a> (يلزم حساب على Github)
</font></b>
<br />

			
			</div><!-- /.container -->

			<footer>


	    		<table style="width:100%;">
<tr>
<td style="text-align: center; border: none;"><a href="#">الرجوع للأعلى</a></li>
        	
				</td><td style="text-align: center; border: none;">
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/deed.ar"><img alt="رخصة المشاع الابداعي" style="border-width:0" src="/assets/ccl.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">موقع ملهم</span> مرخّص بموجب <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/deed.ar">رخصة المشاع الإبداعي نسب المصنف - غير تجاري 4.0 دولي</a>.</td>
<td style="text-align: center; border: none;"><a href="mailto:mulham94@gmail.com">البريد الإلكتروني</a></td></tr></table>
			</footer>
		</body>
	</html>

